(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     26289,        622]
NotebookOptionsPosition[     25514,        595]
NotebookOutlinePosition[     25869,        611]
CellTagsIndexPosition[     25826,        608]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Needs", "[", "\"\<MATLink`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"OpenMATLAB", "[", "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.637354442533819*^9, 3.637354442536193*^9}, {
  3.638376113675886*^9, 3.6383761197461147`*^9}, {3.638545353869639*^9, 
  3.638545354234289*^9}, {3.6385801781095667`*^9, 3.6385801792993383`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Daily", " ", "Risk"}], "-", 
    RowBox[{"free", " ", "rate"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Rf", " ", "=", " ", 
     RowBox[{
      RowBox[{"Log", "[", "1.02", "]"}], "/", "365"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"rc", "=", 
     RowBox[{
      RowBox[{"Log", "[", "1.15", "]"}], "/", "365"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Beta]1", "=", "0.2"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Beta]2", "=", "1"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Standard", " ", "Deviation", " ", "renormalization", " ", "constant"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Rho]", "=", "3."}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.6373526232919903`*^9, 3.637352641358612*^9}, {
  3.638538933352219*^9, 3.6385389897403193`*^9}, {3.63854293491181*^9, 
  3.638542935047607*^9}, {3.6385766621357317`*^9, 3.638576680725683*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"x", "[", "y_Integer", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{"ticker", ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "dayNumbers", ",", "weekNumbers", ",", "dates", ",", "prices", ",", 
         "vol20Days", ",", "vol50Days", ",", "volume"}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"dates", ",", "prices"}], "}"}], "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"FinancialData", "[", 
           RowBox[{"ticker", ",", "\"\<Price\>\"", ",", 
            RowBox[{"{", "y", "}"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"vol20Days", "=", 
         RowBox[{"FinancialData", "[", 
          RowBox[{"ticker", ",", "\"\<Volatility20Day\>\"", ",", 
           RowBox[{"{", "y", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"vol50Days", "=", 
         RowBox[{"FinancialData", "[", 
          RowBox[{"ticker", ",", "\"\<Volatility50Day\>\"", ",", 
           RowBox[{"{", "y", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"volume", "=", 
         RowBox[{"Last", "@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FinancialData", "[", 
            RowBox[{"ticker", ",", "\"\<Volume\>\"", ",", 
             RowBox[{"{", "y", "}"}]}], "]"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"dayNumbers", "=", 
         RowBox[{"dayNumber", "/@", "dates"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"weekNumbers", "=", 
         RowBox[{"weekNumberISO", "/@", "dates"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Check", " ", "if", " ", "vol", " ", "data", " ", "are", " ", "of", 
          " ", "correct", " ", "length"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"vol50Days", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
            RowBox[{"Length", "[", "vol50Days", "]"}]}], ",", 
           RowBox[{"Most", "@", "vol50Days"}], ",", "vol50Days"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"vol20Days", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
            RowBox[{"Length", "[", "vol20Days", "]"}]}], ",", 
           RowBox[{"Most", "@", "vol20Days"}], ",", "vol20Days"}], "]"}]}], 
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"Remove", " ", "last", " ", "element"}], ",", " ", 
          RowBox[{
          "there", " ", "shall", " ", "be", " ", "another", " ", "function", 
           " ", "to", " ", "return", " ", 
           RowBox[{"today", "'"}], "s", " ", "news"}]}], " ", "*)"}], " ", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Most", "@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{
            "dayNumbers", ",", "weekNumbers", ",", "prices", ",", "vol20Days",
              ",", "vol50Days", ",", "volume"}], "}"}], "]"}]}], "//", 
         "N"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"r", "[", "y_Integer", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{"ticker", ",", "\[IndentingNewLine]", 
     RowBox[{"Last", "@", 
      RowBox[{"Transpose", "@", 
       RowBox[{"FinancialData", "[", 
        RowBox[{"ticker", ",", "\"\<Return\>\"", ",", 
         RowBox[{"{", "y", "}"}]}], "]"}]}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.637278324407186*^9, 3.637278333143497*^9}, {
   3.637278364447509*^9, 3.637278371687311*^9}, {3.637278426681796*^9, 
   3.637278427504147*^9}, {3.63727852145175*^9, 3.637278847052188*^9}, {
   3.637278996636752*^9, 3.637279041832982*^9}, {3.637279215625557*^9, 
   3.637279265234088*^9}, 3.6372793003021393`*^9, {3.637281514397505*^9, 
   3.637281582573395*^9}, {3.6372822565754967`*^9, 3.637282256635898*^9}, {
   3.637353451213023*^9, 3.637353485078521*^9}, {3.637353595343758*^9, 
   3.6373536340360107`*^9}, {3.637354202222045*^9, 3.637354241921074*^9}, {
   3.637354514096134*^9, 3.637354529454775*^9}, {3.637354750103245*^9, 
   3.6373548003535013`*^9}, {3.6373548373557367`*^9, 
   3.6373548890926933`*^9}, {3.637355074361277*^9, 3.637355078377404*^9}, {
   3.637355461632481*^9, 3.637355485902697*^9}, {3.637357224164147*^9, 
   3.637357243581153*^9}, {3.637799454339313*^9, 3.6377995070242367`*^9}, {
   3.637800386648649*^9, 3.637800387348172*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"weekNumberISO", "[", "date_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"day0", ",", "year"}], "}"}], ",", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"days", "=", 
        RowBox[{"{", 
         RowBox[{
         "\"\<Mon\>\"", ",", "\"\<Tue\>\"", ",", "\"\<Wed\>\"", ",", 
          "\"\<Thu\>\"", ",", "\"\<Fri\>\"", ",", "\"\<Sat\>\"", ",", 
          "\"\<Sun\>\""}], "}"}]}], "}"}], ",", 
      RowBox[{
       RowBox[{"year", "=", 
        RowBox[{"ToExpression", "[", 
         RowBox[{"DateString", "[", 
          RowBox[{"date", ",", "\"\<Year\>\""}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"day0", "=", 
        RowBox[{"DatePlus", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"year", ",", "1", ",", "4"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"1", "-", 
             RowBox[{
              RowBox[{"Position", "[", 
               RowBox[{"days", ",", 
                RowBox[{"DateString", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"year", ",", "1", ",", "4"}], "}"}], ",", 
                  "\"\<DayNameShort\>\""}], "]"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ",", "\"\<Day\>\""}], 
           "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"1", "+", 
        RowBox[{"Floor", "[", 
         RowBox[{
          RowBox[{"DateDifference", "[", 
           RowBox[{"day0", ",", "date", ",", "\"\<Week\>\""}], "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}]}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.637280878402464*^9, 3.637280878404545*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dayNumber", "[", "date_", "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DateString", "[", 
    RowBox[{"date", ",", "\"\<DayName\>\""}], "]"}], "/.", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<Monday\>\"", "\[Rule]", "1"}], ",", 
     RowBox[{"\"\<Tuesday\>\"", "\[Rule]", "2"}], ",", 
     RowBox[{"\"\<Wednesday\>\"", "\[Rule]", "3"}], ",", 
     RowBox[{"\"\<Thursday\>\"", "\[Rule]", "4"}], ",", 
     RowBox[{"\"\<Friday\>\"", "\[Rule]", "5"}], ",", 
     RowBox[{"\"\<Saturday\>\"", "\[Rule]", "6"}], ",", 
     RowBox[{"\"\<Sunday\>\"", "\[Rule]", "7"}]}], "}"}]}]}]], "Input",
 CellChangeTimes->{{3.6372814258148108`*^9, 3.637281448351781*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"U", ",", "Listable"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"U", "[", "p_Real", "]"}], ":=", 
   RowBox[{
    RowBox[{"\[Beta]1", " ", 
     RowBox[{"(", 
      RowBox[{"p", "-", "rc"}], ")"}]}], "+", 
    RowBox[{"Min", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"\[Beta]2", "-", "\[Beta]1"}], ")"}], "*", 
       RowBox[{"(", 
        RowBox[{"p", "-", "rc"}], ")"}]}], ",", "0"}], "]"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.6372858158390417`*^9, 3.637285833104273*^9}, {
  3.6372859745891743`*^9, 3.6372859920629797`*^9}, {3.6372863609429293`*^9, 
  3.637286391602461*^9}, {3.637286524399839*^9, 3.637286524580285*^9}, {
  3.6373526481788473`*^9, 3.6373526518327713`*^9}, {3.6373527938637466`*^9, 
  3.6373528101040688`*^9}, {3.638539046501543*^9, 3.638539087132876*^9}, {
  3.638540579526684*^9, 3.638540582699134*^9}, {3.638541897237727*^9, 
  3.638541910484112*^9}, {3.63857320733877*^9, 3.638573242423506*^9}, {
  3.638574895290515*^9, 3.638574909485688*^9}, {3.6385751304448423`*^9, 
  3.63857513082803*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "return", " ", "on", " ", "a", " ", "stock", " ", "given", " ", "q", " ", 
     "and", " ", "its", " ", "next"}], "-", 
    RowBox[{"day", " ", "return"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"p", "[", 
     RowBox[{"x_List", ",", "r_Real"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"q", ",", 
      RowBox[{
       RowBox[{"r", " ", 
        RowBox[{"q", ".", "x"}]}], "+", 
       RowBox[{"Rf", 
        RowBox[{"(", 
         RowBox[{"1", "-", 
          RowBox[{"q", ".", "x"}]}], ")"}]}]}]}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.637352542861945*^9, 3.637352596770791*^9}, {
  3.637352671350371*^9, 3.6373527318570013`*^9}, {3.637352806359825*^9, 
  3.637352870591525*^9}, {3.637353087932302*^9, 3.637353088460475*^9}, {
  3.63735407171563*^9, 3.6373540834023943`*^9}, {3.637358825372855*^9, 
  3.637358826091959*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Average", " ", "utility", " ", "with", " ", "respect", " ", "to", " ", 
    "q", " ", "from", " ", "date", " ", "y"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"objective", "[", 
     RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"q", ",", "\[IndentingNewLine]", 
      RowBox[{"With", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"allFeatures", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"x", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
            "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"allReturns", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
            "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Total", "[", 
         RowBox[{"U", "/@", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"MapThread", "[", 
             RowBox[{"p", ",", 
              RowBox[{"{", 
               RowBox[{"allFeatures", ",", "allReturns"}], "}"}]}], "]"}], 
            "[", "q", "]"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}],
      "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.637353028715088*^9, 3.637353035763673*^9}, {
  3.637353204897333*^9, 3.637353292764289*^9}, {3.6373533774113197`*^9, 
  3.637353386395473*^9}, {3.637353881932197*^9, 3.637353883892741*^9}, {
  3.637354006640139*^9, 3.63735405480562*^9}, {3.637354125463132*^9, 
  3.6373541558068533`*^9}, {3.637355012135242*^9, 3.637355043954466*^9}, {
  3.63735508677842*^9, 3.637355092794897*^9}, {3.637355647394771*^9, 
  3.637355649875637*^9}, {3.637356671362501*^9, 3.637356690593233*^9}, {
  3.6373570742862473`*^9, 3.637357173517803*^9}, {3.637357258917201*^9, 
  3.6373572654419107`*^9}, {3.637357491374017*^9, 3.637357493166731*^9}, {
  3.637357657795133*^9, 3.6373576817443113`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solveObjective", "[", 
    RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{"Call", " ", "to", " ", "Data"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[CapitalPhi]", "=", 
        RowBox[{"\[CapitalPhi]", "[", 
         RowBox[{
          RowBox[{"x", "[", "y", "]"}], "/@", "stocks"}], "]"}]}], ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Matrix", " ", "of", " ", "features", " ", "of", " ", "the", " ", 
         RowBox[{"form", " ", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"x11", "^", "T"}], ";", 
             RowBox[{"x12", "^", "T"}], ";", 
             RowBox[{"x13", "^", "T"}], ";"}], "..."}], ";", 
           RowBox[{"xNN", "^", "T"}]}], "]"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"rs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
         "]"}]}]}], " ", 
      RowBox[{"(*", " ", 
       RowBox[{"Vector", " ", "of", " ", "returns"}], " ", "*)"}], 
      "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Last", "@", 
      RowBox[{"cvxSolve", "[", 
       RowBox[{"\[CapitalPhi]", ",", "rs"}], "]"}]}]}], "\[IndentingNewLine]",
     "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.637433543962352*^9, 3.637433618268734*^9}, {
   3.637433784789402*^9, 3.6374338681991796`*^9}, {3.6374340496495237`*^9, 
   3.637434114386417*^9}, {3.637434196720015*^9, 3.63743421679729*^9}, {
   3.637435898854578*^9, 3.63743593017124*^9}, {3.637435960717751*^9, 
   3.637435977024015*^9}, {3.637436099141057*^9, 3.637436145106986*^9}, {
   3.637436176577359*^9, 3.637436185497452*^9}, {3.63743627477104*^9, 
   3.637436307252296*^9}, {3.637436345725025*^9, 3.637436735723419*^9}, {
   3.63743690793891*^9, 3.637436908210205*^9}, 3.637448174599373*^9, {
   3.637530871674211*^9, 3.637530878771762*^9}, {3.63753517982446*^9, 
   3.637535208806211*^9}, {3.6375355262213287`*^9, 3.63753557286379*^9}, {
   3.637535655403945*^9, 3.637535659643635*^9}, {3.637535785341851*^9, 
   3.6375358089533567`*^9}, 3.6377668421248817`*^9, {3.63776698748386*^9, 
   3.637766990754651*^9}, {3.637767463900136*^9, 3.637767488579896*^9}, 
   3.6377738742032337`*^9, 3.637773907528207*^9, 3.6377822148288507`*^9, {
   3.637782265280479*^9, 3.6377822901728573`*^9}, 3.6377826942405243`*^9, {
   3.637782797177659*^9, 3.6377828043206882`*^9}, 3.6377828413689613`*^9, {
   3.637783072516371*^9, 3.637783076371587*^9}, 3.637783122715187*^9, {
   3.637783617272441*^9, 3.637783621126233*^9}, 3.6377836546666603`*^9, {
   3.637785085214738*^9, 3.637785089625492*^9}, {3.637800425421752*^9, 
   3.637800432501172*^9}, {3.638217642802312*^9, 3.6382176463539457`*^9}, {
   3.638278546174609*^9, 3.6382785465281677`*^9}, {3.638285120693712*^9, 
   3.638285158657668*^9}, {3.6382857965529833`*^9, 3.638285814109027*^9}, {
   3.638286160966704*^9, 3.638286163540659*^9}, {3.638289247994294*^9, 
   3.638289361213889*^9}, {3.638312583905151*^9, 3.6383126147149067`*^9}, 
   3.6383128473383293`*^9, {3.6383129094505997`*^9, 3.6383129451287537`*^9}, {
   3.63831338587127*^9, 3.638313439775526*^9}, {3.6383134765567417`*^9, 
   3.63831352405534*^9}, {3.638314175893118*^9, 3.638314197442114*^9}, {
   3.638316619765337*^9, 3.638316621340906*^9}, {3.638351168719152*^9, 
   3.638351173426458*^9}, {3.638366772529181*^9, 3.6383667943280478`*^9}, 
   3.638366834164937*^9, {3.638371736679616*^9, 3.638371747285128*^9}, {
   3.638374117873307*^9, 3.6383741675801163`*^9}, {3.638374200136364*^9, 
   3.6383742610471983`*^9}, {3.638374704253037*^9, 3.6383747046745462`*^9}, {
   3.638375220540291*^9, 3.638375220858675*^9}, {3.638375375418767*^9, 
   3.638375375487928*^9}, {3.6384630100065813`*^9, 3.638463046676312*^9}, {
   3.6384630835907383`*^9, 3.6384631104299097`*^9}, {3.6384631426663446`*^9, 
   3.638463222908802*^9}, {3.638463259486126*^9, 3.638463330375435*^9}, 
   3.638463403862336*^9, {3.63846371787785*^9, 3.6384637226102543`*^9}, {
   3.638464076793047*^9, 3.638464082677985*^9}, {3.6384647597514687`*^9, 
   3.638464817344206*^9}, {3.638464900703511*^9, 3.6384649105979443`*^9}, {
   3.638538920597403*^9, 3.6385389263371*^9}, {3.6385391315563107`*^9, 
   3.6385392608137083`*^9}, {3.638541770373126*^9, 3.638541774652368*^9}, {
   3.638543885635517*^9, 3.6385438860723257`*^9}, {3.63854523383764*^9, 
   3.638545271742044*^9}, {3.63857526377002*^9, 3.638575315104043*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPhi]", "[", "xs_List", "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"newXs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"xs", ",", "1"}], "]"}]}], ",", "A", ",", "b"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "=", 
       RowBox[{"scaleMatrix", "[", 
        RowBox[{"newXs", ",", "\[Rho]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"b", "=", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{
         RowBox[{"meanVector", "[", "newXs", "]"}], ",", 
         RowBox[{"Length", "[", "newXs", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"newXs", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"newXs", "-", "b"}], ")"}], ".", "A"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ArrayFlatten", "[", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"1", ",", "newXs"}], "}"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.637800438920693*^9, 3.637800491287294*^9}, {
   3.637804352630316*^9, 3.637804356896595*^9}, {3.6378049110389147`*^9, 
   3.6378049758175983`*^9}, {3.6382853770797243`*^9, 3.638285409693372*^9}, {
   3.638285466286581*^9, 3.638285494890761*^9}, {3.638572273132599*^9, 
   3.638572275594718*^9}, 3.638575272545834*^9, {3.6385764889716177`*^9, 
   3.6385765093374977`*^9}, {3.638576546128902*^9, 3.638576561328333*^9}, {
   3.638577808055326*^9, 3.6385778662155123`*^9}, {3.638577910532749*^9, 
   3.638577934190897*^9}, {3.638578993558798*^9, 3.638578995661467*^9}, {
   3.638579039787367*^9, 3.638579076719832*^9}, {3.6385791697479687`*^9, 
   3.63857919732298*^9}, {3.6385800957784243`*^9, 3.638580097130905*^9}, 
   3.6385801598146563`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"scaleMatrix", "[", 
    RowBox[{"xs_", ",", "\[Rho]_"}], "]"}], ":=", 
   RowBox[{"DiagonalMatrix", "[", 
    RowBox[{"\[Rho]", "/", 
     RowBox[{"StandardDeviation", "[", "xs", "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"meanVector", "[", "xs_", "]"}], ":=", 
   RowBox[{"Mean", "[", "xs", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.638576564027177*^9, 3.6385765720176563`*^9}, {
   3.638576620577523*^9, 3.638576635993273*^9}, {3.638576686951272*^9, 
   3.638576716568536*^9}, 3.638576993538497*^9, {3.638577029941227*^9, 
   3.63857703057216*^9}, {3.638577087508953*^9, 3.6385770898004293`*^9}, {
   3.638577889751449*^9, 3.6385779076824713`*^9}, {3.6385782306163177`*^9, 
   3.638578253586533*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"cvxSolve", "[", 
    RowBox[{"xs_List", ",", "rs_List"}], "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<xs\>\"", ",", "xs"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rs\>\"", ",", "rs"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<b1\>\"", ",", "\[Beta]1"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<b2\>\"", ",", "\[Beta]2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<Rf\>\"", ",", "Rf"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rc\>\"", ",", "rc"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Call", " ", "CVX", " ", "in", " ", "Matlab", " ", "with", " ", 
        "Matlink", " ", "and", " ", "display", " ", "output"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "@", 
       RowBox[{
       "MEvaluate", "[", 
        "\"\<\n[n p] = size(xs);\n\nU = @(p) b1*(p-rc) + min((b2-b1)*(p-rc), \
0);\n\ncvx_begin\n    variable q(p)\n    maximize(sum(U(rs'.*(xs*q) + \
Rf*(1-xs*q))))\ncvx_end\n\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Return", " ", "utility", " ", "value", " ", "and", " ", "argmax"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"MGet", "[", "\"\<cvx_optval\>\"", "]"}], ",", 
        RowBox[{"Flatten", "@", 
         RowBox[{"MGet", "[", "\"\<q\>\"", "]"}]}]}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.638468389632174*^9, 3.638468409067391*^9}, {
   3.6385441771403427`*^9, 3.638544178408065*^9}, {3.638544240611012*^9, 
   3.638544336213842*^9}, {3.638544385809187*^9, 3.6385444094345703`*^9}, {
   3.638544473260137*^9, 3.638544559222435*^9}, 3.638544858067051*^9, {
   3.638544894651911*^9, 3.638544920805359*^9}, {3.638544954980818*^9, 
   3.638544980251333*^9}, {3.638545327080653*^9, 3.638545350968774*^9}, {
   3.6385722397162952`*^9, 3.638572250931685*^9}, {3.638572283954956*^9, 
   3.638572290015128*^9}, {3.6385728621006107`*^9, 3.638572877554515*^9}, 
   3.638575340561442*^9, 3.6385754353371153`*^9, {3.6385755264738483`*^9, 
   3.638575527385621*^9}, {3.638575559297846*^9, 3.638575580036481*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "First", " ", "value", " ", "returns", " ", "total", " ", "return", " ", 
     "on", " ", "the", " ", "period"}], ",", " ", 
    RowBox[{
    "last", " ", "value", " ", "returns", " ", "incremental", " ", 
     "returns"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"rawReturns", "[", 
     RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"rs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
         "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Times", "@@", 
         RowBox[{"Flatten", "[", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"1", "+", "rs"}]}], "}"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"FoldList", "[", 
         RowBox[{"Times", ",", "1", ",", 
          RowBox[{"1", "+", "rs"}]}], "]"}]}], "}"}]}], "\[IndentingNewLine]",
      "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.63857544430761*^9, 3.638575444776642*^9}, {
  3.6386265153916893`*^9, 3.638626690518754*^9}, {3.63862675662965*^9, 
  3.6386267584952307`*^9}, {3.638626797816659*^9, 3.6386267982551947`*^9}, {
  3.638626835057726*^9, 3.638626867737754*^9}, {3.638626947284851*^9, 
  3.638626978123185*^9}, {3.638627018626539*^9, 3.638627020665264*^9}}]
},
WindowSize->{1135, 1055},
WindowMargins->{{Automatic, 16}, {Automatic, 0}},
FrontEndVersion->"10.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (June 27, \
2014)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 94, 2, 28, "Input"],
Cell[655, 24, 389, 8, 46, "Input"],
Cell[1047, 34, 1103, 30, 148, "Input"],
Cell[2153, 66, 4899, 103, 403, "Input"],
Cell[7055, 171, 1813, 48, 80, "Input"],
Cell[8871, 221, 707, 15, 46, "Input"],
Cell[9581, 238, 1159, 27, 46, "Input"],
Cell[10743, 267, 966, 25, 46, "Input"],
Cell[11712, 294, 2139, 48, 148, "Input"],
Cell[13854, 344, 4729, 85, 165, "Input"],
Cell[18586, 431, 1898, 43, 148, "Input"],
Cell[20487, 476, 798, 18, 46, "Input"],
Cell[21288, 496, 2632, 55, 420, "Input"],
Cell[23923, 553, 1587, 40, 131, "Input"]
}
]
*)

(* End of internal cache information *)
