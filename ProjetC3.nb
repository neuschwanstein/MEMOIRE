(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     60795,       1424]
NotebookOptionsPosition[     58546,       1359]
NotebookOutlinePosition[     58906,       1375]
CellTagsIndexPosition[     58863,       1372]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Needs", "[", "\"\<MATLink`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"OpenMATLAB", "[", "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.637354442533819*^9, 3.637354442536193*^9}, {
  3.638376113675886*^9, 3.6383761197461147`*^9}, {3.638545353869639*^9, 
  3.638545354234289*^9}, {3.6385801781095667`*^9, 3.6385801792993383`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Daily", " ", "Risk"}], "-", 
    RowBox[{"free", " ", 
     RowBox[{"rate", ".", " ", "252"}], " ", "trading", " ", "days", " ", 
     "in", " ", "a", " ", "year"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Rf", " ", "=", " ", 
     RowBox[{
      RowBox[{"Log", "[", "1.02", "]"}], "/", "252"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"rc", "=", 
     RowBox[{
      RowBox[{"Log", "[", "1.02", "]"}], "/", "252"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Beta]1", "=", "1"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Beta]2", "=", "1"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Standard", " ", "Deviation", " ", "renormalization", " ", "constant"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Rho]", "=", "3."}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     SubscriptBox["\[Mu]", "s"], "=", "1.0"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"n1", "=", "21"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"n2", "=", 
     RowBox[{"2", "n1"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"n3", "=", 
     RowBox[{"3", "n1"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.6373526232919903`*^9, 3.637352641358612*^9}, {
  3.638538933352219*^9, 3.6385389897403193`*^9}, {3.63854293491181*^9, 
  3.638542935047607*^9}, {3.6385766621357317`*^9, 3.638576680725683*^9}, {
  3.6386283765602827`*^9, 3.638628385862918*^9}, {3.638665780144771*^9, 
  3.638665780576034*^9}, {3.638710955006173*^9, 3.638710977443837*^9}, {
  3.63871991042255*^9, 3.638719910716501*^9}, {3.638741563053665*^9, 
  3.638741581658968*^9}, {3.6387605927012043`*^9, 3.638760606634076*^9}, {
  3.639280079586873*^9, 3.639280080262608*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rawFeatures", "[", 
     RowBox[{"yStart_Integer", ",", "yEnd_Integer"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"ticker", ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "dayNumbers", ",", "weekNumbers", ",", "dates", ",", "prices", ",", 
          "vol20Days", ",", "vol50Days", ",", "volume", ",", "averageNDays"}],
          "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{
          "\"\<Calling financial features feeds for \>\"", "<>", "ticker"}], 
          "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"dates", ",", "prices"}], "}"}], "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FinancialData", "[", 
            RowBox[{"ticker", ",", "\"\<Price\>\"", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"yStart", ",", "1", ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"yEnd", ",", "1", ",", "1"}], "}"}]}], "}"}]}], "]"}],
            "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"Take", "[", 
           RowBox[{
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volatility20Day\>\"", ",", 
              RowBox[{"{", "yStart", "}"}]}], "]"}], ",", 
            RowBox[{"Length", "[", "prices", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"Take", "[", 
           RowBox[{
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volatility50Day\>\"", ",", 
              RowBox[{"{", "yStart", "}"}]}], "]"}], ",", 
            RowBox[{"Length", "[", "prices", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"volume", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volume\>\"", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"yStart", ",", "1", ",", "1"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"yEnd", ",", "1", ",", "1"}], "}"}]}], "}"}]}], 
             "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"dayNumbers", "=", 
          RowBox[{"dayNumber", "/@", "dates"}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"weekNumbers", "=", 
          RowBox[{"weekNumberISO", "/@", "dates"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Check", " ", "if", " ", "vol", " ", "data", " ", "are", " ", "of", 
           " ", "correct", " ", "length"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol50Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol50Days"}], ",", "vol50Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol20Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol20Days"}], ",", "vol20Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"Most", "@", 
          RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
            "dayNumbers", ",", "weekNumbers", ",", "prices", ",", "vol20Days",
              ",", "vol50Days", ",", "volume"}], "}"}], "]"}]}]}]}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6392741223909883`*^9, 3.639274171494356*^9}, {
  3.639274236766141*^9, 3.639274272026657*^9}, {3.639274370725214*^9, 
  3.639274411796733*^9}, {3.6392766016006527`*^9, 3.639276629451289*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"This", " ", "method", " ", "is", " ", "too", " ", "slow"}], 
    "..."}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"augmentFeaturesMatrix", "[", 
      RowBox[{"\[Mu]d_", ",", "\[Mu]w_", ",", "n1_", ",", "n2_", ",", "n3_"}],
       "]"}], ":=", 
     RowBox[{"Function", "[", 
      RowBox[{"matrix", ",", "\[IndentingNewLine]", 
       RowBox[{"Module", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
          "dates", ",", "prices", ",", "vol20Days", ",", "vol50Days", ",", 
           "volume", ",", "weekNumbers", ",", "dayNumbers", ",", 
           "averageNDays"}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "dayNumbers", ",", "weekNumbers", ",", "prices", ",", "vol20Days",
              ",", "vol50Days", ",", "volume"}], "}"}], "=", 
           RowBox[{"Transpose", "[", "matrix", "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"dayNumbers", "=", 
           RowBox[{"Through", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"dayFeature", "[", "\[Mu]d", "]"}], "/@", 
               RowBox[{"Range", "[", "5", "]"}]}], ")"}], "[", "dayNumbers", 
             "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"weekNumbers", "=", 
           RowBox[{"Through", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"weekFeature", "[", "\[Mu]w", "]"}], "/@", 
               RowBox[{"Range", "[", "52", "]"}]}], ")"}], "[", "weekNumbers",
              "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"averageNDays", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"generalizedMovingAverage", "[", 
              RowBox[{"prices", ",", "#"}], "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"n1", ",", "n2", ",", "n3"}], "}"}]}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"{", 
                RowBox[{
                "dayNumbers", ",", "weekNumbers", ",", "prices", ",", 
                 "vol20Days", ",", "vol50Days", ",", "averageNDays", ",", 
                 "volume"}], "}"}], "]"}], ",", 
              RowBox[{"Length", "[", "prices", "]"}]}], "]"}], 
            "\[IndentingNewLine]", "]"}], "//", "N"}]}]}], 
        "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}],
    "\[IndentingNewLine]", "\[IndentingNewLine]"}]}]], "Input",
 CellChangeTimes->{{3.639275128382066*^9, 3.6392751360245*^9}, {
  3.639275198689546*^9, 3.6392752236886463`*^9}, {3.6392753555930023`*^9, 
  3.639275533733049*^9}, {3.639275851215818*^9, 3.639275913037444*^9}, {
  3.639275960923464*^9, 3.639276136201902*^9}, {3.639276213950715*^9, 
  3.639276252188387*^9}, {3.639276640114706*^9, 3.6392766558257723`*^9}, {
  3.63927681366499*^9, 3.6392768205764513`*^9}, {3.639277199087243*^9, 
  3.63927719983834*^9}, {3.63927734839048*^9, 3.639277354590582*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"Old", " ", "feature", " ", "methods"}], "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.},
 CellChangeTimes->{{3.639275749324382*^9, 3.639275760373563*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"x", "[", 
     RowBox[{"yStart_Integer", ",", "yEnd_Integer"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"ticker", ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "dayNumbers", ",", "weekNumbers", ",", "dates", ",", "prices", ",", 
          "vol20Days", ",", "vol50Days", ",", "volume", ",", "averageNDays"}],
          "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{
          "\"\<Calling financial features feeds for \>\"", "<>", "ticker"}], 
          "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"dates", ",", "prices"}], "}"}], "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FinancialData", "[", 
            RowBox[{"ticker", ",", "\"\<Price\>\"", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"yStart", ",", "1", ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"yEnd", ",", "1", ",", "1"}], "}"}]}], "}"}]}], "]"}],
            "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"Take", "[", 
           RowBox[{
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volatility20Day\>\"", ",", 
              RowBox[{"{", "yStart", "}"}]}], "]"}], ",", 
            RowBox[{"Length", "[", "prices", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"Take", "[", 
           RowBox[{
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volatility50Day\>\"", ",", 
              RowBox[{"{", "yStart", "}"}]}], "]"}], ",", 
            RowBox[{"Length", "[", "prices", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"volume", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volume\>\"", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"yStart", ",", "1", ",", "1"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"yEnd", ",", "1", ",", "1"}], "}"}]}], "}"}]}], 
             "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"dayNumbers", "=", 
          RowBox[{"dayNumber", "/@", "dates"}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"weekNumbers", "=", 
          RowBox[{"weekNumberISO", "/@", "dates"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Check", " ", "if", " ", "vol", " ", "data", " ", "are", " ", "of", 
           " ", "correct", " ", "length"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol50Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol50Days"}], ",", "vol50Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol20Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol20Days"}], ",", "vol20Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"averageNDays", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"generalizedMovingAverage", "[", 
             RowBox[{"prices", ",", "#"}], "]"}], "&"}], "/@", 
           RowBox[{"{", 
            RowBox[{"n1", ",", "n2", ",", "n3"}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"dayNumbers", "=", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"dayFeature", "/@", 
              RowBox[{"Range", "[", "5", "]"}]}], ")"}], "[", "dayNumbers", 
            "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"weekNumbers", "=", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"weekFeature", "/@", 
              RowBox[{"Range", "[", "52", "]"}]}], ")"}], "[", "weekNumbers", 
            "]"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"Remove", " ", "last", " ", "element"}], ",", " ", 
           RowBox[{
           "there", " ", "shall", " ", "be", " ", "another", " ", "function", 
            " ", "to", " ", "return", " ", 
            RowBox[{"today", "'"}], "s", " ", "news"}]}], "  ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Most", "@", 
           RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"{", 
                RowBox[{
                "dayNumbers", ",", "weekNumbers", ",", "prices", ",", 
                 "vol20Days", ",", "vol50Days", ",", "averageNDays", ",", 
                 "volume"}], "}"}], "]"}], ",", 
              RowBox[{"Length", "[", "prices", "]"}]}], "]"}], 
            "\[IndentingNewLine]", "]"}]}], "//", "N"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"x", "[", "y_Integer", "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"ticker", ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "dayNumbers", ",", "weekNumbers", ",", "dates", ",", "prices", ",", 
          "vol20Days", ",", "vol50Days", ",", "volume", ",", "averageNDays"}],
          "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{
          "\"\<Calling financial features feeds for \>\"", "<>", "ticker"}], 
          "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"dates", ",", "prices"}], "}"}], "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{"FinancialData", "[", 
            RowBox[{"ticker", ",", "\"\<Price\>\"", ",", 
             RowBox[{"{", "y", "}"}]}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"FinancialData", "[", 
           RowBox[{"ticker", ",", "\"\<Volatility20Day\>\"", ",", 
            RowBox[{"{", "y", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"FinancialData", "[", 
           RowBox[{"ticker", ",", "\"\<Volatility50Day\>\"", ",", 
            RowBox[{"{", "y", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"volume", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"Transpose", "[", 
            RowBox[{"FinancialData", "[", 
             RowBox[{"ticker", ",", "\"\<Volume\>\"", ",", 
              RowBox[{"{", "y", "}"}]}], "]"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"dayNumbers", "=", 
          RowBox[{"dayNumber", "/@", "dates"}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"weekNumbers", "=", 
          RowBox[{"weekNumberISO", "/@", "dates"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Check", " ", "if", " ", "vol", " ", "data", " ", "are", " ", "of", 
           " ", "correct", " ", "length"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"vol50Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol50Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol50Days"}], ",", "vol50Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"vol20Days", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "prices", "]"}], "\[NotEqual]", 
             RowBox[{"Length", "[", "vol20Days", "]"}]}], ",", 
            RowBox[{"Most", "@", "vol20Days"}], ",", "vol20Days"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"averageNDays", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"generalizedMovingAverage", "[", 
             RowBox[{"prices", ",", "#"}], "]"}], "&"}], "/@", 
           RowBox[{"{", 
            RowBox[{"n1", ",", "n2", ",", "n3"}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"dayNumbers", "=", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"dayFeature", "/@", 
              RowBox[{"Range", "[", "5", "]"}]}], ")"}], "[", "dayNumbers", 
            "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"weekNumbers", "=", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"weekFeature", "/@", 
              RowBox[{"Range", "[", "52", "]"}]}], ")"}], "[", "weekNumbers", 
            "]"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"Remove", " ", "last", " ", "element"}], ",", " ", 
           RowBox[{
           "there", " ", "shall", " ", "be", " ", "another", " ", "function", 
            " ", "to", " ", "return", " ", 
            RowBox[{"today", "'"}], "s", " ", "news"}]}], "  ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Most", "@", 
           RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"Flatten", "[", 
               RowBox[{"{", 
                RowBox[{
                "dayNumbers", ",", "weekNumbers", ",", "prices", ",", 
                 "vol20Days", ",", "vol50Days", ",", "averageNDays", ",", 
                 "volume"}], "}"}], "]"}], ",", 
              RowBox[{"Length", "[", "prices", "]"}]}], "]"}], 
            "\[IndentingNewLine]", "]"}]}], "//", "N"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"r", "[", 
     RowBox[{"yStart_Integer", ",", "yEnd_Integer"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"ticker", ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"\"\<Calling returns values for \>\"", "<>", "ticker"}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Last", "@", 
        RowBox[{"Transpose", "@", 
         RowBox[{"FinancialData", "[", 
          RowBox[{"ticker", ",", "\"\<Return\>\"", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"yStart", ",", "1", ",", "1"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"yEnd", ",", "1", ",", "1"}], "}"}]}], "}"}]}], 
          "]"}]}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"r", "[", "y_Integer", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{"ticker", ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{"\"\<Calling returns values for \>\"", "<>", "ticker"}], "]"}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"Last", "@", 
       RowBox[{"Transpose", "@", 
        RowBox[{"FinancialData", "[", 
         RowBox[{"ticker", ",", "\"\<Return\>\"", ",", 
          RowBox[{"{", "y", "}"}]}], "]"}]}]}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.},
 CellChangeTimes->{{3.637278324407186*^9, 3.637278333143497*^9}, {
   3.637278364447509*^9, 3.637278371687311*^9}, {3.637278426681796*^9, 
   3.637278427504147*^9}, {3.63727852145175*^9, 3.637278847052188*^9}, {
   3.637278996636752*^9, 3.637279041832982*^9}, {3.637279215625557*^9, 
   3.637279265234088*^9}, 3.6372793003021393`*^9, {3.637281514397505*^9, 
   3.637281582573395*^9}, {3.6372822565754967`*^9, 3.637282256635898*^9}, {
   3.637353451213023*^9, 3.637353485078521*^9}, {3.637353595343758*^9, 
   3.6373536340360107`*^9}, {3.637354202222045*^9, 3.637354241921074*^9}, {
   3.637354514096134*^9, 3.637354529454775*^9}, {3.637354750103245*^9, 
   3.6373548003535013`*^9}, {3.6373548373557367`*^9, 
   3.6373548890926933`*^9}, {3.637355074361277*^9, 3.637355078377404*^9}, {
   3.637355461632481*^9, 3.637355485902697*^9}, {3.637357224164147*^9, 
   3.637357243581153*^9}, {3.637799454339313*^9, 3.6377995070242367`*^9}, {
   3.637800386648649*^9, 3.637800387348172*^9}, {3.6386641921542673`*^9, 
   3.63866423761421*^9}, {3.638664277171918*^9, 3.638664284723724*^9}, {
   3.638664705260219*^9, 3.6386647328832283`*^9}, 3.638665952222795*^9, {
   3.63871923595984*^9, 3.6387192685593357`*^9}, {3.638720035922673*^9, 
   3.638720068594195*^9}, {3.6387416129806213`*^9, 3.638741620598165*^9}, {
   3.638741651502103*^9, 3.6387416754604588`*^9}, {3.638741843796698*^9, 
   3.638741896767192*^9}, {3.638741973525528*^9, 3.638741991901163*^9}, {
   3.6387606194132767`*^9, 3.6387607344077806`*^9}, {3.639235404429891*^9, 
   3.6392354156617613`*^9}, {3.63923544934006*^9, 3.639235478711738*^9}, {
   3.639235905262434*^9, 3.6392359359985447`*^9}, {3.639235968836072*^9, 
   3.639235974633151*^9}, {3.6392379173916407`*^9, 3.6392379339302063`*^9}, {
   3.6392403049942493`*^9, 3.639240376642077*^9}, 3.639275760374344*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{"Date", " ", "feature"}], " ", "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.638719514268655*^9, 3.638719523612186*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"weekNumberISO", "[", "date_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"day0", ",", "year"}], "}"}], ",", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"days", "=", 
        RowBox[{"{", 
         RowBox[{
         "\"\<Mon\>\"", ",", "\"\<Tue\>\"", ",", "\"\<Wed\>\"", ",", 
          "\"\<Thu\>\"", ",", "\"\<Fri\>\"", ",", "\"\<Sat\>\"", ",", 
          "\"\<Sun\>\""}], "}"}]}], "}"}], ",", 
      RowBox[{
       RowBox[{"year", "=", 
        RowBox[{"ToExpression", "[", 
         RowBox[{"DateString", "[", 
          RowBox[{"date", ",", "\"\<Year\>\""}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"day0", "=", 
        RowBox[{"DatePlus", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"year", ",", "1", ",", "4"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"1", "-", 
             RowBox[{
              RowBox[{"Position", "[", 
               RowBox[{"days", ",", 
                RowBox[{"DateString", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"year", ",", "1", ",", "4"}], "}"}], ",", 
                  "\"\<DayNameShort\>\""}], "]"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ",", "\"\<Day\>\""}], 
           "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"1", "+", 
        RowBox[{"Floor", "[", 
         RowBox[{
          RowBox[{"DateDifference", "[", 
           RowBox[{"day0", ",", "date", ",", "\"\<Week\>\""}], "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}]}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.637280878402464*^9, 3.637280878404545*^9}, 
   3.638719523612378*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dayNumber", "[", "date_", "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DateString", "[", 
    RowBox[{"date", ",", "\"\<DayName\>\""}], "]"}], "/.", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<Monday\>\"", "\[Rule]", "1"}], ",", 
     RowBox[{"\"\<Tuesday\>\"", "\[Rule]", "2"}], ",", 
     RowBox[{"\"\<Wednesday\>\"", "\[Rule]", "3"}], ",", 
     RowBox[{"\"\<Thursday\>\"", "\[Rule]", "4"}], ",", 
     RowBox[{"\"\<Friday\>\"", "\[Rule]", "5"}], ",", 
     RowBox[{"\"\<Saturday\>\"", "\[Rule]", "6"}], ",", 
     RowBox[{"\"\<Sunday\>\"", "\[Rule]", "7"}]}], "}"}]}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.6372814258148108`*^9, 3.637281448351781*^9}, 
   3.638719523612487*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"dayFeature", "[", "\[Mu]d_", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{"d", ",", "\[IndentingNewLine]", 
     RowBox[{"Function", "[", 
      RowBox[{"x", ",", "\[IndentingNewLine]", 
       RowBox[{"Exp", "[", 
        RowBox[{"\[Mu]d", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Mod", "[", 
            RowBox[{
             RowBox[{"x", "-", "d"}], ",", "5", ",", "1"}], "]"}], "-", "5"}],
           ")"}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"{", "Listable", "}"}]}], "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.638719425648435*^9, 3.638719436219533*^9}, 
   3.6387195236125927`*^9, {3.639259640906332*^9, 3.639259641102909*^9}, {
   3.6392750279244633`*^9, 3.639275034936882*^9}, {3.63927563324303*^9, 
   3.639275681520626*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"weekFeature", "[", "\[Mu]w_", "]"}], ":=", 
   RowBox[{"Function", "[", 
    RowBox[{"w", ",", "\[IndentingNewLine]", 
     RowBox[{"Function", "[", 
      RowBox[{"x", ",", "\[IndentingNewLine]", 
       RowBox[{"Exp", "[", 
        RowBox[{"\[Mu]w", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Mod", "[", 
            RowBox[{
             RowBox[{"x", "-", "w"}], ",", "52", ",", "1"}], "]"}], "-", 
           "52"}], ")"}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"{", "Listable", "}"}]}], "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.638719447965374*^9, 3.6387194668244658`*^9}, 
   3.638719523612694*^9, {3.639259671415639*^9, 3.639259689765492*^9}, {
   3.639259724549774*^9, 3.639259731321006*^9}, {3.639275063131968*^9, 
   3.639275073953436*^9}, {3.639275658617334*^9, 3.639275701010983*^9}}]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"U", ",", "Listable"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"U", "[", "p_Real", "]"}], ":=", 
   RowBox[{
    RowBox[{"\[Beta]1", " ", 
     RowBox[{"(", 
      RowBox[{"p", "-", "rc"}], ")"}]}], "+", 
    RowBox[{"Min", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"\[Beta]2", "-", "\[Beta]1"}], ")"}], "*", 
       RowBox[{"(", 
        RowBox[{"p", "-", "rc"}], ")"}]}], ",", "0"}], "]"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.6372858158390417`*^9, 3.637285833104273*^9}, {
  3.6372859745891743`*^9, 3.6372859920629797`*^9}, {3.6372863609429293`*^9, 
  3.637286391602461*^9}, {3.637286524399839*^9, 3.637286524580285*^9}, {
  3.6373526481788473`*^9, 3.6373526518327713`*^9}, {3.6373527938637466`*^9, 
  3.6373528101040688`*^9}, {3.638539046501543*^9, 3.638539087132876*^9}, {
  3.638540579526684*^9, 3.638540582699134*^9}, {3.638541897237727*^9, 
  3.638541910484112*^9}, {3.63857320733877*^9, 3.638573242423506*^9}, {
  3.638574895290515*^9, 3.638574909485688*^9}, {3.6385751304448423`*^9, 
  3.63857513082803*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "return", " ", "on", " ", "a", " ", "stock", " ", "given", " ", "q", " ", 
     "and", " ", "its", " ", "next"}], "-", 
    RowBox[{"day", " ", "return"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"p", "[", 
     RowBox[{"x_List", ",", "r_Real"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"q", ",", 
      RowBox[{
       RowBox[{"r", " ", 
        RowBox[{"q", ".", "x"}]}], "+", 
       RowBox[{"Rf", 
        RowBox[{"(", 
         RowBox[{"1", "-", 
          RowBox[{"q", ".", "x"}]}], ")"}]}]}]}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.637352542861945*^9, 3.637352596770791*^9}, {
  3.637352671350371*^9, 3.6373527318570013`*^9}, {3.637352806359825*^9, 
  3.637352870591525*^9}, {3.637353087932302*^9, 3.637353088460475*^9}, {
  3.63735407171563*^9, 3.6373540834023943`*^9}, {3.637358825372855*^9, 
  3.637358826091959*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Average", " ", "utility", " ", "with", " ", "respect", " ", "to", " ", 
    "q", " ", "from", " ", "date", " ", "y"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"objective", "[", 
     RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
    RowBox[{"Function", "[", 
     RowBox[{"q", ",", "\[IndentingNewLine]", 
      RowBox[{"With", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"allFeatures", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"x", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
            "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"allReturns", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
            "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Total", "[", 
         RowBox[{"U", "/@", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"MapThread", "[", 
             RowBox[{"p", ",", 
              RowBox[{"{", 
               RowBox[{"allFeatures", ",", "allReturns"}], "}"}]}], "]"}], 
            "[", "q", "]"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}],
      "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.637353028715088*^9, 3.637353035763673*^9}, {
  3.637353204897333*^9, 3.637353292764289*^9}, {3.6373533774113197`*^9, 
  3.637353386395473*^9}, {3.637353881932197*^9, 3.637353883892741*^9}, {
  3.637354006640139*^9, 3.63735405480562*^9}, {3.637354125463132*^9, 
  3.6373541558068533`*^9}, {3.637355012135242*^9, 3.637355043954466*^9}, {
  3.63735508677842*^9, 3.637355092794897*^9}, {3.637355647394771*^9, 
  3.637355649875637*^9}, {3.637356671362501*^9, 3.637356690593233*^9}, {
  3.6373570742862473`*^9, 3.637357173517803*^9}, {3.637357258917201*^9, 
  3.6373572654419107`*^9}, {3.637357491374017*^9, 3.637357493166731*^9}, {
  3.637357657795133*^9, 3.6373576817443113`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"solveObjective", "[", 
    RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[CapitalPhi]", "=", 
        RowBox[{"First", "[", 
         RowBox[{"\[CapitalPhi]", "[", 
          RowBox[{
           RowBox[{"x", "[", "y", "]"}], "/@", "stocks"}], "]"}], "]"}]}], 
       ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Matrix", " ", "of", " ", "features", " ", "of", " ", "the", " ", 
         RowBox[{"form", " ", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"x11", "^", "T"}], ";", 
             RowBox[{"x12", "^", "T"}], ";", 
             RowBox[{"x13", "^", "T"}], ";"}], "..."}], ";", 
           RowBox[{"xNN", "^", "T"}]}], "]"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"rs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}], ",", "1"}], 
         "]"}]}]}], " ", 
      RowBox[{"(*", " ", 
       RowBox[{"Vector", " ", "of", " ", "returns"}], " ", "*)"}], 
      "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Last", "@", 
      RowBox[{"cvxSolve", "[", 
       RowBox[{"\[CapitalPhi]", ",", "rs"}], "]"}]}]}], "\[IndentingNewLine]",
     "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.637433543962352*^9, 3.637433618268734*^9}, {
   3.637433784789402*^9, 3.6374338681991796`*^9}, {3.6374340496495237`*^9, 
   3.637434114386417*^9}, {3.637434196720015*^9, 3.63743421679729*^9}, {
   3.637435898854578*^9, 3.63743593017124*^9}, {3.637435960717751*^9, 
   3.637435977024015*^9}, {3.637436099141057*^9, 3.637436145106986*^9}, {
   3.637436176577359*^9, 3.637436185497452*^9}, {3.63743627477104*^9, 
   3.637436307252296*^9}, {3.637436345725025*^9, 3.637436735723419*^9}, {
   3.63743690793891*^9, 3.637436908210205*^9}, 3.637448174599373*^9, {
   3.637530871674211*^9, 3.637530878771762*^9}, {3.63753517982446*^9, 
   3.637535208806211*^9}, {3.6375355262213287`*^9, 3.63753557286379*^9}, {
   3.637535655403945*^9, 3.637535659643635*^9}, {3.637535785341851*^9, 
   3.6375358089533567`*^9}, 3.6377668421248817`*^9, {3.63776698748386*^9, 
   3.637766990754651*^9}, {3.637767463900136*^9, 3.637767488579896*^9}, 
   3.6377738742032337`*^9, 3.637773907528207*^9, 3.6377822148288507`*^9, {
   3.637782265280479*^9, 3.6377822901728573`*^9}, 3.6377826942405243`*^9, {
   3.637782797177659*^9, 3.6377828043206882`*^9}, 3.6377828413689613`*^9, {
   3.637783072516371*^9, 3.637783076371587*^9}, 3.637783122715187*^9, {
   3.637783617272441*^9, 3.637783621126233*^9}, 3.6377836546666603`*^9, {
   3.637785085214738*^9, 3.637785089625492*^9}, {3.637800425421752*^9, 
   3.637800432501172*^9}, {3.638217642802312*^9, 3.6382176463539457`*^9}, {
   3.638278546174609*^9, 3.6382785465281677`*^9}, {3.638285120693712*^9, 
   3.638285158657668*^9}, {3.6382857965529833`*^9, 3.638285814109027*^9}, {
   3.638286160966704*^9, 3.638286163540659*^9}, {3.638289247994294*^9, 
   3.638289361213889*^9}, {3.638312583905151*^9, 3.6383126147149067`*^9}, 
   3.6383128473383293`*^9, {3.6383129094505997`*^9, 3.6383129451287537`*^9}, {
   3.63831338587127*^9, 3.638313439775526*^9}, {3.6383134765567417`*^9, 
   3.63831352405534*^9}, {3.638314175893118*^9, 3.638314197442114*^9}, {
   3.638316619765337*^9, 3.638316621340906*^9}, {3.638351168719152*^9, 
   3.638351173426458*^9}, {3.638366772529181*^9, 3.6383667943280478`*^9}, 
   3.638366834164937*^9, {3.638371736679616*^9, 3.638371747285128*^9}, {
   3.638374117873307*^9, 3.6383741675801163`*^9}, {3.638374200136364*^9, 
   3.6383742610471983`*^9}, {3.638374704253037*^9, 3.6383747046745462`*^9}, {
   3.638375220540291*^9, 3.638375220858675*^9}, {3.638375375418767*^9, 
   3.638375375487928*^9}, {3.6384630100065813`*^9, 3.638463046676312*^9}, {
   3.6384630835907383`*^9, 3.6384631104299097`*^9}, {3.6384631426663446`*^9, 
   3.638463222908802*^9}, {3.638463259486126*^9, 3.638463330375435*^9}, 
   3.638463403862336*^9, {3.63846371787785*^9, 3.6384637226102543`*^9}, {
   3.638464076793047*^9, 3.638464082677985*^9}, {3.6384647597514687`*^9, 
   3.638464817344206*^9}, {3.638464900703511*^9, 3.6384649105979443`*^9}, {
   3.638538920597403*^9, 3.6385389263371*^9}, {3.6385391315563107`*^9, 
   3.6385392608137083`*^9}, {3.638541770373126*^9, 3.638541774652368*^9}, {
   3.638543885635517*^9, 3.6385438860723257`*^9}, {3.63854523383764*^9, 
   3.638545271742044*^9}, {3.63857526377002*^9, 3.638575315104043*^9}, {
   3.638657024177887*^9, 3.638657024443592*^9}, {3.63865727035063*^9, 
   3.638657276663793*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{
   RowBox[{"FIXME", " ", 
    RowBox[{"here", ".", " ", "We"}], " ", "need", " ", "\[CapitalPhi]"}], 
   ",", 
   RowBox[{"A", " ", "and", " ", "b", " ", "separately"}]}], " ", 
  "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{3.638657401163906*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[CapitalPhi]", "[", "xs_List", "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"A", ",", "b"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "=", 
        RowBox[{"scaleMatrix", "[", 
         RowBox[{"xs", ",", "\[Rho]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", "=", 
        RowBox[{"Mean", "[", "xs", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\[CapitalPhi]", "[", 
          RowBox[{"xs", ",", "A", ",", "b"}], "]"}], ",", "A", ",", "b"}], 
        "}"}]}]}], " ", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"This", " ", "here"}], ".."}], " ", "*)"}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalPhi]", "[", 
    RowBox[{
     RowBox[{"xs_", "?", "MatrixQ"}], ",", 
     RowBox[{"A_", "?", "MatrixQ"}], ",", 
     RowBox[{"b_", "?", "VectorQ"}]}], "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"newXs", ",", 
       RowBox[{"B", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"b", ",", 
          RowBox[{"Length", "[", "xs", "]"}]}], "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"newXs", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"xs", "-", "B"}], ")"}], ".", "A"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ArrayFlatten", "[", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"1", ",", "newXs"}], "}"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.637800438920693*^9, 3.637800491287294*^9}, {
   3.637804352630316*^9, 3.637804356896595*^9}, {3.6378049110389147`*^9, 
   3.6378049758175983`*^9}, {3.6382853770797243`*^9, 3.638285409693372*^9}, {
   3.638285466286581*^9, 3.638285494890761*^9}, {3.638572273132599*^9, 
   3.638572275594718*^9}, 3.638575272545834*^9, {3.6385764889716177`*^9, 
   3.6385765093374977`*^9}, {3.638576546128902*^9, 3.638576561328333*^9}, {
   3.638577808055326*^9, 3.6385778662155123`*^9}, {3.638577910532749*^9, 
   3.638577934190897*^9}, {3.638578993558798*^9, 3.638578995661467*^9}, {
   3.638579039787367*^9, 3.638579076719832*^9}, {3.6385791697479687`*^9, 
   3.63857919732298*^9}, {3.6385800957784243`*^9, 3.638580097130905*^9}, 
   3.6385801598146563`*^9, {3.6386431081974087`*^9, 3.638643154883321*^9}, {
   3.638643226133771*^9, 3.638643270210795*^9}, {3.6386443540351963`*^9, 
   3.638644493326727*^9}, {3.6386486269779577`*^9, 3.638648657169154*^9}, {
   3.6386489017329817`*^9, 3.6386489542091703`*^9}, {3.6386489869934607`*^9, 
   3.638649042696598*^9}, 3.6386566242275753`*^9, {3.638657009010406*^9, 
   3.638657009499158*^9}, {3.638657194553966*^9, 3.638657258736927*^9}, {
   3.638657394981957*^9, 3.6386574011641417`*^9}, {3.638743804565942*^9, 
   3.638743806296392*^9}, {3.638748339006044*^9, 3.638748341324258*^9}, {
   3.6387485379884653`*^9, 3.638748541714778*^9}, {3.638748960056077*^9, 
   3.638748962047576*^9}, {3.638752320155702*^9, 3.638752322620531*^9}, {
   3.639237232344247*^9, 3.639237249126894*^9}}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"scaleMatrix", "[", 
      RowBox[{"xs_", ",", "\[Rho]_"}], "]"}], ":=", 
     RowBox[{"DiagonalMatrix", "[", 
      RowBox[{"\[Rho]", "/", 
       RowBox[{"StandardDeviation", "[", "xs", "]"}]}], "]"}]}], ";"}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"scaleMatrix", "[", 
      RowBox[{"xs_", ",", "\[Rho]_"}], "]"}], ":=", 
     RowBox[{"SparseArray", "@", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"1", "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Max", "/@", 
           RowBox[{"Transpose", "[", "xs", "]"}]}], "-", 
          RowBox[{"Min", "/@", 
           RowBox[{"Transpose", "[", "xs", "]"}]}]}], ")"}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"scaleMatrix", "[", 
       RowBox[{"xs_", ",", "\[Rho]_"}], "]"}], ":=", 
      RowBox[{"SparseArray", "@", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"1", "/", 
         RowBox[{"Max", "/@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"Abs", "[", "xs", "]"}], "]"}]}]}], "]"}]}]}], ";"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"scaleMatrix", "[", 
       RowBox[{"xs_", ",", "\[Rho]_"}], "]"}], ":=", 
      RowBox[{"SparseArray", "@", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"1.", "/", 
         RowBox[{"(", 
          RowBox[{"Norm", "/@", "xs"}], ")"}]}], "]"}]}]}], ";"}], "*)"}], 
   "\[IndentingNewLine]"}]}]], "Input",
 CellChangeTimes->{{3.638576564027177*^9, 3.6385765720176563`*^9}, {
   3.638576620577523*^9, 3.638576635993273*^9}, {3.638576686951272*^9, 
   3.638576716568536*^9}, 3.638576993538497*^9, {3.638577029941227*^9, 
   3.63857703057216*^9}, {3.638577087508953*^9, 3.6385770898004293`*^9}, {
   3.638577889751449*^9, 3.6385779076824713`*^9}, {3.6385782306163177`*^9, 
   3.638578253586533*^9}, 3.638657013892535*^9, {3.638742061987515*^9, 
   3.638742074756276*^9}, {3.638742116444907*^9, 3.638742133810687*^9}, {
   3.6387421696284323`*^9, 3.638742208924309*^9}, {3.638742803609338*^9, 
   3.638742824868925*^9}, {3.638742872395442*^9, 3.638742885523138*^9}, {
   3.638743727487543*^9, 3.638743730455434*^9}, {3.638744427650128*^9, 
   3.638744429864229*^9}, {3.638744928595497*^9, 3.638744930945696*^9}, {
   3.638748291870452*^9, 3.638748324122921*^9}, {3.6387485117800694`*^9, 
   3.638748516998673*^9}, {3.638748558091312*^9, 3.6387485610616493`*^9}, {
   3.638749008993778*^9, 3.638749039946973*^9}, {3.63875233204804*^9, 
   3.638752342180006*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{"CVX", " ", "Call"}], " ", "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.6386569580654383`*^9, 3.638656978301196*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"cvxSolve", "[", 
    RowBox[{"xs_List", ",", "rs_List"}], "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<xs\>\"", ",", "xs"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rs\>\"", ",", "rs"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<b1\>\"", ",", "\[Beta]1"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<b2\>\"", ",", "\[Beta]2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<Rf\>\"", ",", "Rf"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rc\>\"", ",", "rc"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Call", " ", "CVX", " ", "in", " ", "Matlab", " ", "with", " ", 
        "Matlink", " ", "and", " ", "display", " ", "output"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "@", 
       RowBox[{
       "MEvaluate", "[", 
        "\"\<\n[n p] = size(xs);\n\nU = @(p) b1*(p-rc) + min(0, \
(b2-b1)*(p-rc));\n\ncvx_begin\n    variable q(p)\n    maximize( \
sum(U(rs'.*(xs*q) + Rf*(1-xs*q))) )\ncvx_end\n\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Return", " ", "utility", " ", "value", " ", "and", " ", "argmax"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"MGet", "[", "\"\<cvx_optval\>\"", "]"}], ",", 
        RowBox[{"Flatten", "@", 
         RowBox[{"MGet", "[", "\"\<q\>\"", "]"}]}]}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellChangeTimes->{{3.638468389632174*^9, 3.638468409067391*^9}, {
   3.6385441771403427`*^9, 3.638544178408065*^9}, {3.638544240611012*^9, 
   3.638544336213842*^9}, {3.638544385809187*^9, 3.6385444094345703`*^9}, {
   3.638544473260137*^9, 3.638544559222435*^9}, 3.638544858067051*^9, {
   3.638544894651911*^9, 3.638544920805359*^9}, {3.638544954980818*^9, 
   3.638544980251333*^9}, {3.638545327080653*^9, 3.638545350968774*^9}, {
   3.6385722397162952`*^9, 3.638572250931685*^9}, {3.638572283954956*^9, 
   3.638572290015128*^9}, {3.6385728621006107`*^9, 3.638572877554515*^9}, 
   3.638575340561442*^9, 3.6385754353371153`*^9, {3.6385755264738483`*^9, 
   3.638575527385621*^9}, {3.638575559297846*^9, 3.638575580036481*^9}, 
   3.6386569783015127`*^9, {3.638664496279256*^9, 3.638664560671879*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{"Raw", " ", "Returns"}], " ", "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.},
 CellChangeTimes->{{3.6386569957980003`*^9, 3.638657001001217*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rawReturns", "[", 
     RowBox[{"stock_String", ",", "y_Integer"}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"rawReturns", "[", 
     RowBox[{
      RowBox[{"{", "stock", "}"}], ",", "y", ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "0"}], "}"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rawReturns", "[", 
     RowBox[{"stocks_List", ",", "y_Integer"}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"l", "=", 
        RowBox[{"Length", "[", "stocks", "]"}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"rawReturns", "[", 
       RowBox[{"stocks", ",", "y", ",", 
        RowBox[{
         RowBox[{"ConstantArray", "[", 
          RowBox[{
           RowBox[{"1", "/", "l"}], ",", "l"}], "]"}], "~", "Join", "~", 
         RowBox[{"{", "0", "}"}]}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rawReturns", "[", 
    RowBox[{"stocks_List", ",", "y_Integer", ",", "pfComposition_List"}], 
    "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"rs", ",", "riskFree"}], "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"rs", "=", 
       RowBox[{
        RowBox[{"r", "[", "y", "]"}], "/@", "stocks"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"riskFree", "=", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"Rf", ",", 
         RowBox[{"Last", "[", 
          RowBox[{"Dimensions", "[", "rs", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"rs", "=", 
       RowBox[{"Total", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Most", "[", "pfComposition", "]"}], "*", "rs"}], ")"}], 
         "\[IndentingNewLine]", "~", "Join", "~", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Last", "[", "pfComposition", "]"}], "*", "riskFree"}], 
          "}"}]}], "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"FoldList", "[", 
       RowBox[{"Times", ",", "1", ",", 
        RowBox[{"1", "+", "rs"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}],
   ";"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.},
 CellChangeTimes->{{3.63857544430761*^9, 3.638575444776642*^9}, {
   3.6386265153916893`*^9, 3.638626690518754*^9}, {3.63862675662965*^9, 
   3.6386267584952307`*^9}, {3.638626797816659*^9, 3.6386267982551947`*^9}, {
   3.638626835057726*^9, 3.638626867737754*^9}, {3.638626947284851*^9, 
   3.638626978123185*^9}, {3.638627018626539*^9, 3.638627020665264*^9}, {
   3.6386271295584593`*^9, 3.638627199445907*^9}, {3.638627244190126*^9, 
   3.638627385723068*^9}, {3.6386274824146423`*^9, 3.638627485998294*^9}, {
   3.6386275632309637`*^9, 3.638627587630908*^9}, {3.63862770510944*^9, 
   3.6386277295383263`*^9}, {3.638628462678845*^9, 3.638628466381941*^9}, {
   3.638628504736085*^9, 3.6386285397076397`*^9}, {3.638628604766325*^9, 
   3.638628712550276*^9}, 3.638629123632806*^9, {3.638629287891097*^9, 
   3.6386292887266808`*^9}, {3.6386293442875557`*^9, 
   3.6386293597384853`*^9}, {3.638629393743626*^9, 3.638629442848847*^9}, {
   3.6386295615500517`*^9, 3.638629563396893*^9}, {3.638629656423044*^9, 
   3.6386296572860937`*^9}, {3.638629965715613*^9, 3.6386299675799627`*^9}, {
   3.638656984627922*^9, 3.638657001001478*^9}}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"testModel", "[", "\[IndentingNewLine]", 
    RowBox[{
    "trainingStocks_List", ",", "\[IndentingNewLine]", 
     "trainingYears_Integer", ",", "\[IndentingNewLine]", "testStock_String", 
     ",", "\[IndentingNewLine]", "testYear_Integer"}], "]"}], ":=", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "\[CapitalPhi]", ",", "A", ",", "b", ",", "rs", ",", "q", ",", "p", ",",
        "testingXs", ",", "testing\[CapitalPhi]", ",", "testReturns", ",", 
       "actualReturns"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[CapitalPhi]", ",", "A", ",", "b"}], "}"}], "=", 
       RowBox[{"\[CapitalPhi]", "[", 
        RowBox[{
         RowBox[{"x", "[", "trainingYears", "]"}], "/@", "trainingStocks"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rs", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"r", "[", "trainingYears", "]"}], "/@", "trainingStocks"}], 
         ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"q", "=", 
       RowBox[{"Last", "@", 
        RowBox[{"cvxSolve", "[", 
         RowBox[{"\[CapitalPhi]", ",", "rs"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"testingXs", "=", 
       RowBox[{
        RowBox[{"x", "[", "testYear", "]"}], "[", "testStock", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"testing\[CapitalPhi]", "=", 
       RowBox[{"\[CapitalPhi]", "[", 
        RowBox[{"testingXs", ",", "A", ",", "b"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"p", "=", 
       RowBox[{"testing\[CapitalPhi]", ".", "q"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"testReturns", "=", 
       RowBox[{
        RowBox[{"r", "[", "testYear", "]"}], "[", "testStock", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"actualReturns", "=", 
       RowBox[{
        RowBox[{"testReturns", "*", "p"}], "+", 
        RowBox[{"Rf", "*", 
         RowBox[{"(", 
          RowBox[{"1", "-", "p"}], ")"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"FoldList", "[", 
       RowBox[{"Times", ",", "1", ",", 
        RowBox[{"1", "+", "actualReturns"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.638641027934492*^9, 3.638641067654222*^9}, {
   3.6386411126463823`*^9, 3.638641114629136*^9}, {3.638641190983305*^9, 
   3.638641192760343*^9}, {3.638641240007598*^9, 3.638641267589819*^9}, {
   3.638641436475865*^9, 3.638641442489399*^9}, {3.6386421090362463`*^9, 
   3.6386422241242933`*^9}, 3.638642287836124*^9, {3.638642367380231*^9, 
   3.638642389905835*^9}, {3.638642480488165*^9, 3.6386424808719673`*^9}, {
   3.638657382132386*^9, 3.638657388374185*^9}, {3.638657437094379*^9, 
   3.638657467636359*^9}, {3.6386575054134274`*^9, 3.638657547217342*^9}, {
   3.638657907821575*^9, 3.63865798410682*^9}, {3.638658020271346*^9, 
   3.638658067722658*^9}, {3.6386633866125307`*^9, 3.638663502369001*^9}, {
   3.638663539951722*^9, 3.638663566616103*^9}, {3.6386637344495363`*^9, 
   3.638663755408271*^9}, {3.638663812480795*^9, 3.638663872186803*^9}, {
   3.638663969935672*^9, 3.63866397993591*^9}, {3.638664248887868*^9, 
   3.6386642496355753`*^9}, {3.638664308637094*^9, 3.6386643130281363`*^9}, {
   3.6386655595050592`*^9, 3.638665628032716*^9}, {3.638665988458785*^9, 
   3.638665989652204*^9}, {3.639004216147078*^9, 3.6390042207444143`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"findQ", "=", 
   RowBox[{"MFunction", "[", "\"\<getOpt\>\"", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6392381483118477`*^9, 3.639238150617887*^9}, {
  3.639238208048224*^9, 3.639238235279476*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Needs", "[", "\"\<MATLink`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"OpenMATLAB", "[", "]"}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"magic", "=", 
   RowBox[{"MFunction", "[", "\"\<magic\>\"", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.639239025197357*^9, 3.6392390314431973`*^9}}],

Cell[BoxData[
 RowBox[{"ClearAll", "[", "findQ", "]"}]], "Input",
 CellChangeTimes->{{3.6392390852285023`*^9, 3.6392390887149773`*^9}, {
  3.639239140419033*^9, 3.639239140922516*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"findQ", "[", 
    RowBox[{"rc_", ",", "b2_", ",", "xs_", ",", "rs_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rc\>\"", ",", "rc"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<b2\>\"", ",", "b2"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<xs\>\"", ",", "xs"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MSet", "[", 
       RowBox[{"\"\<rs\>\"", ",", "rs"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "@", 
       RowBox[{
       "MEvaluate", "[", 
        "\"\<\nif (~iscolumn(rs))\n    rs = rs';\nend\n\nRf = log(1.02)/252;\n\
[n p] = size(xs);\nb1=1;\nU = @(p) b1*(p-rc) + min(0, (b2-b1)*(p-rc));\n\n\
cvx_begin\n    variable q(p)\n    maximize(sum(U(rs.*(xs*q) + Rf*(1-xs*q))))\n\
    subject to\n        norm(q,2) <= 1\ncvx_end\n\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Flatten", "@", 
       RowBox[{"MGet", "[", "\"\<q\>\"", "]"}]}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.639239135981022*^9, 3.639239186827997*^9}, {
  3.639239302404604*^9, 3.639239339658403*^9}, {3.639239377055193*^9, 
  3.63923941701833*^9}, {3.639240253326519*^9, 3.6392402534542923`*^9}}]
},
WindowSize->{1135, 1055},
WindowMargins->{{Automatic, -220}, {-286, Automatic}},
FrontEndVersion->"10.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (June 27, \
2014)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 94, 2, 28, "Input"],
Cell[655, 24, 389, 8, 46, "Input"],
Cell[1047, 34, 1937, 49, 233, "Input"],
Cell[2987, 85, 4569, 101, 488, "Input"],
Cell[7559, 188, 3355, 73, 301, "Input"],
Cell[CellGroupData[{
Cell[10939, 265, 217, 4, 28, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.}],
Cell[11159, 271, 14235, 309, 1151, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.}]
}, Open  ]],
Cell[CellGroupData[{
Cell[25431, 585, 212, 4, 28, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[25646, 591, 1892, 50, 80, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[27541, 643, 786, 17, 46, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[28330, 662, 926, 22, 97, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[29259, 686, 975, 22, 97, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[30249, 711, 1159, 27, 46, "Input"],
Cell[31411, 740, 966, 25, 46, "Input"],
Cell[32380, 767, 2139, 48, 148, "Input"],
Cell[34522, 817, 4764, 86, 148, "Input"],
Cell[CellGroupData[{
Cell[39311, 907, 338, 9, 28, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[39652, 918, 3396, 75, 233, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[43063, 996, 2660, 63, 97, "Input"],
Cell[CellGroupData[{
Cell[45748, 1063, 210, 4, 28, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[45961, 1069, 2761, 57, 420, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[CellGroupData[{
Cell[48759, 1131, 213, 4, 28, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.}],
Cell[48975, 1137, 3677, 84, 369, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10001.}]
}, Open  ]],
Cell[52667, 1224, 3603, 75, 335, "Input"],
Cell[56273, 1301, 238, 5, 28, "Input"],
Cell[56514, 1308, 173, 5, 46, "Input"],
Cell[56690, 1315, 188, 4, 28, "Input"],
Cell[56881, 1321, 184, 3, 28, "Input"],
Cell[57068, 1326, 1474, 31, 454, "Input"]
}
]
*)

(* End of internal cache information *)
